```{r data}
# load packages
library(DBI)
library(RPostgres)
library(dplyr)
library(tidytext)
library(tidyverse)

# connect to database
con <- dbConnect(RPostgres::Postgres(),dbname = 'postgres',
                 host = 'localhost',
                 port = 5432,
                 user = 'postgres',
                 password = 'vannah') 

# make and execute query
res <- dbSendQuery(con, "

SELECT DISTINCT(t.id_str), text, display_text_range, retweet_count, favorite_count
FROM rocketleague_text AS t
INNER JOIN rocketleague_data AS d
ON d.id_str = t.id_str

-- DISTINCT(t.id_str) eliminates duplicates 
                   
                   ")

query_df <- dbFetch(res)

# clear query and disconnect from database
dbClearResult(res)
dbDisconnect(con)

# clean data
db_new <- unnest_tokens(tbl = query_df, input = text, output = word)

stp_wrds <- get_stopwords(source = "smart")

db_new <- anti_join(db_new, stp_wrds, by = "word")

bing <- get_sentiments(lexicon = "bing")

db_bing <- inner_join(db_new, bing, by = "word")

db_bing <- count(db_bing, id_str, retweet_count, favorite_count, word, sentiment)

db_bing <- spread(key = sentiment, value = n, fill = 0, data = db_bing)


db_bing <- mutate(sentiment = positive - negative, .data = db_bing)

mean(db_bing$sentiment, na.rm = TRUE)
```

```{r analyze and visualize sentiment}
#----  ----#
library(RColorBrewer)
fun_color_range <- colorRampPalette(c("red", "green"))
my_colors2 <- fun_color_range(2)

db_sentiment <- db_bing %>% 
  mutate(value = case_when(sentiment > 0 ~ 'positive',
                           sentiment == 0 ~ 'neutral',
                           sentiment < 0 ~ 'negative')) %>%
  filter(value == 'positive' | value == 'negative')

db_sentiment %>%
  arrange(desc(favorite_count),desc(retweet_count)) %>%
  group_by(id_str) %>%
  summarise(id_str, sentiment = sum(sentiment), favorite_count = mean(favorite_count), retweet_count = mean(retweet_count)) %>% 
  ggplot(mapping = aes(x = id_str, y = sentiment, color = sentiment)) +
  geom_col(alpha = .6) + 
  scale_colour_gradientn(colors = my_colors2) +
  theme_classic() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) + 
  labs(title = "Rocket League Tweet Sentiment", x = "Tweet", y = "Sentiment")
```

```{r analyze correlation}
library(tidytext)
library(tidyverse)
library(widyr) # for pairwise correlation 
library(igraph) # for data visualization
library(ggraph) # for data visualization

tweet_words <- query_df %>% 
  unnest_tokens(output = word, input = text) %>% 
  anti_join(stop_words, by = "word") %>% 
  filter(str_detect(word, "[:alpha:]")) %>% 
  distinct()

#---- remove non-words ----#
word <- c('https','t.co')
extra2 <- data.frame(word)

tweet_words <- tweet_words %>%
  anti_join(extra2, by = "word")

#---- first visual ----#
tweets_that_mention_word <- tweet_words %>% 
  count(word, name = "number_of_tweets") %>% 
  filter(number_of_tweets >= 20)


tweet_correlations <- tweet_words %>% 
  semi_join(tweets_that_mention_word, by = "word") %>% 
  pairwise_cor(item = word, feature = id_str) %>% 
  filter(correlation >= 0.2) 


graph_from_data_frame(d = tweet_correlations,
                      vertices = tweets_that_mention_word %>%
                        semi_join(tweet_correlations, by = c("word" = "item1"))) %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(alpha = correlation)) + 
  geom_node_point() +
  geom_node_text(aes(color = number_of_tweets, label = name), repel = TRUE, check_overlap = TRUE, size = 4) + 
  labs(title = "Rocket League Tweets") +
  scale_colour_gradientn(colours=c("#3e3b92", "#f44369")) +
  theme(panel.background = element_rect(fill = "#eaeaea"),
        plot.background = element_rect(fill = "#ffffff"))
```
